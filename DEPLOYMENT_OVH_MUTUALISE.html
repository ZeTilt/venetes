<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide de Déploiement - OVH Mutualisé</title>
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #fd7e29;
            --bg: #f8f9fa;
            --text: #333;
            --border: #dee2e6;
            --code-bg: #2d3748;
            --success: #28a745;
            --warning: #ffc107;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
        }
        h1 {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
            padding-bottom: 10px;
        }
        h2 {
            color: var(--primary);
            margin-top: 40px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        h3 { color: #555; margin-top: 25px; }
        pre {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        pre code {
            background: none;
            padding: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--primary);
            color: white;
        }
        tr:hover { background: #f1f3f4; }
        .warning {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid var(--success);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .checklist {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .checklist label {
            display: block;
            padding: 8px 0;
            cursor: pointer;
        }
        .checklist input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .copy-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
        .copy-btn:hover { opacity: 0.8; }
        .toc {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .toc ul { padding-left: 20px; }
        .toc a { color: var(--primary); text-decoration: none; }
        .toc a:hover { text-decoration: underline; }
        .schema {
            background: white;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        @media print {
            body { max-width: 100%; }
            .copy-btn { display: none; }
        }
    </style>
</head>
<body>

<h1>Guide de Déploiement - OVH Mutualisé</h1>

<p>Ce guide est spécifique au déploiement sur hébergement mutualisé OVH (Web Hosting).</p>

<nav class="toc">
    <strong>Table des matières</strong>
    <ul>
        <li><a href="#architecture">1. Architecture</a></li>
        <li><a href="#git">2. Configuration Git sur OVH</a></li>
        <li><a href="#php">3. Configuration PHP</a></li>
        <li><a href="#env">4. Variables d'environnement</a></li>
        <li><a href="#deploy">5. Déploiement</a></li>
        <li><a href="#cron">6. Tâches planifiées</a></li>
        <li><a href="#ftp">7. Accès FTP/SSH</a></li>
        <li><a href="#structure">8. Structure des fichiers</a></li>
        <li><a href="#debug">9. Dépannage</a></li>
        <li><a href="#checklist">10. Checklist</a></li>
    </ul>
</nav>

<h2 id="architecture">1. Architecture</h2>

<div class="schema">
OVH Mutualisé (cluster007.ovh.net)
├── plongee-venetes.fr/        # PROD (branche main)
│   ├── .env.local
│   ├── .ovhconfig (PHP 8.3)
│   └── public/
└── beta.plongee-venetes.fr/   # BETA (branche release)
    ├── .env.local
    ├── .ovhconfig (PHP 8.3)
    └── public/

Base de données: O2Switch (externe)
├── empo8897_venetes_prod     # PROD
└── empo8897_venetes_preprod  # BETA
</div>

<h2 id="git">2. Configuration Git sur OVH</h2>

<h3>2.1 Dans le Manager OVH</h3>
<ol>
    <li>Connexion <a href="https://www.ovh.com/manager/" target="_blank">Manager OVH</a></li>
    <li><strong>Web Cloud</strong> → <strong>Hébergements</strong> → <code>plongee-venetes.fr</code></li>
    <li><strong>Multisite</strong> → Sélectionner le sous-domaine</li>
    <li><strong>Modifier</strong> → Section <strong>Déploiement Git</strong></li>
</ol>

<h3>2.2 Configuration du dépôt</h3>
<table>
    <tr><th>Champ</th><th>BETA</th><th>PROD</th></tr>
    <tr><td>Dépôt</td><td colspan="2"><code>https://github.com/ZeTilt/venetes.git</code></td></tr>
    <tr><td>Branche</td><td><code>release</code></td><td><code>main</code></td></tr>
    <tr><td>Répertoire</td><td><code>beta</code></td><td>(racine)</td></tr>
</table>

<h3>2.3 Webhook GitHub</h3>
<p>Aller sur <strong>GitHub</strong> → <strong>ZeTilt/venetes</strong> → <strong>Settings</strong> → <strong>Webhooks</strong> → <strong>Add webhook</strong></p>

<table>
    <tr><th>Champ</th><th>Valeur</th></tr>
    <tr><td>Payload URL</td><td><em>(URL fournie par OVH)</em></td></tr>
    <tr><td>Content type</td><td><code>application/json</code></td></tr>
    <tr><td>Secret</td><td>(laisser vide)</td></tr>
    <tr><td>Events</td><td>☑ Just the push event</td></tr>
</table>

<div class="info">
    <strong>URL Webhook BETA :</strong><br>
    <small style="word-break: break-all;">https://webhooks-webhosting.eu.ovhapis.com/1.0/vcs/github/push/eyJhbGciOiJFZERTQSIsImtpZCI6IjEiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJnaXRodWIvaG04NTAzNS1vdmgiLCJleHAiOjI1MjQ2MDc5OTksImp0aSI6IjM4NDc4ODhlMDA1MDcxOWY0OTBkYTEyOTFlMWU4MTViZDA3NGZiMDAiLCJ2ZXJzaW9uIjoxLCJuYW1lIjoicGxvbmdlZS12ZW5ldGVzLmZyIiwicGF0aCI6ImJldGEiLCJjb3VudGVyIjowfQ.eDi9eGPEpPpR4MAHybGwfpsmZoEEIsjiXCogDhS-WfxI8j4-HuHuVr9H6gI0SywncgbtP745lTSMqUFnCa2yAw</small>
</div>

<h2 id="php">3. Configuration PHP (.ovhconfig)</h2>

<p>Le fichier <code>.ovhconfig</code> à la racine (déjà inclus dans le repo) :</p>
<pre><code>app.engine=php
app.engine.version=8.3
http.firewall=none
environment=production
container.image=stable64</code></pre>

<h2 id="env">4. Variables d'environnement (.env.local)</h2>

<h3>4.1 Connexion FTP</h3>
<table>
    <tr><th>Paramètre</th><th>Valeur</th></tr>
    <tr><td>Serveur</td><td><code>ftp.cluster007.hosting.ovh.net</code></td></tr>
    <tr><td>Port</td><td><code>21</code></td></tr>
    <tr><td>Utilisateur</td><td><code>hmXXXXX-ovh</code> (voir Manager)</td></tr>
</table>

<h3>4.2 Contenu du .env.local</h3>
<p>Créer ce fichier via FTP dans <code>/beta/.env.local</code> :</p>

<pre><code>###> symfony/framework-bundle ###
APP_ENV=prod
APP_DEBUG=false
APP_SECRET=<span style="color:#fd7e29">VOTRE_CLE_64_CHARS</span>
###< symfony/framework-bundle ###

###> doctrine/doctrine-bundle ###
DATABASE_URL="mysql://<span style="color:#fd7e29">USER</span>:<span style="color:#fd7e29">PASS</span>@<span style="color:#fd7e29">IP_O2SWITCH</span>:3306/<span style="color:#fd7e29">DATABASE</span>?serverVersion=8.0&charset=utf8mb4"
###< doctrine/doctrine-bundle ###

###> symfony/mailer ###
MAILER_DSN=smtp://<span style="color:#fd7e29">EMAIL</span>:<span style="color:#fd7e29">PASS</span>@smtp.server.com:465?encryption=ssl&auth_mode=login
###< symfony/mailer ###

###> app/caci ###
CACI_ENCRYPTION_KEY=<span style="color:#fd7e29">VOTRE_CLE_64_CHARS_HEX</span>
###< app/caci ###

###> app/cron ###
CRON_SECRET_TOKEN=<span style="color:#fd7e29">VOTRE_TOKEN_32_CHARS</span>
###< app/cron ###</code></pre>

<h3>4.3 Générer les clés</h3>
<pre><code># APP_SECRET (64 caractères hex)
php -r "echo bin2hex(random_bytes(32));"

# CACI_ENCRYPTION_KEY (64 caractères hex)
openssl rand -hex 32

# CRON_SECRET_TOKEN (32 caractères hex)
php -r "echo bin2hex(random_bytes(16));"</code></pre>

<h3>4.4 Autoriser l'IP OVH sur O2Switch</h3>
<ol>
    <li>Connexion <a href="https://cpanel.o2switch.net" target="_blank">cPanel O2Switch</a></li>
    <li><strong>Bases de données MySQL</strong> → <strong>MySQL distant</strong></li>
    <li>Ajouter l'IP : <code>213.186.33.18</code></li>
</ol>

<h2 id="deploy">5. Déploiement</h2>

<h3>5.1 Flux</h3>
<div class="schema">
git push origin release
        │
        ▼
GitHub Webhook ──────► OVH Git Pull
                              │
                              ▼
                    Appeler deploy.php
                              │
                              ▼
                    ✅ Site mis à jour
</div>

<h3>5.2 URL de déploiement</h3>
<p>Après chaque <code>git push</code>, appeler dans le navigateur :</p>

<div class="success">
    <strong>BETA :</strong><br>
    <code>https://beta.plongee-venetes.fr/deploy.php?token=<span style="color:#fd7e29">VOTRE_TOKEN</span></code>
</div>

<div class="success">
    <strong>PROD :</strong><br>
    <code>https://plongee-venetes.fr/deploy.php?token=<span style="color:#fd7e29">VOTRE_TOKEN</span></code>
</div>

<div class="warning">
    <strong>Token par défaut :</strong> <code>CHANGE_ME_</code> + md5(<code>venetes2025</code>)<br>
    <strong>⚠️ À CHANGER en production !</strong> Modifier dans <code>public/deploy.php</code>
</div>

<h3>5.3 Ce que fait deploy.php</h3>
<ol>
    <li><code>composer install --no-dev --optimize-autoloader</code></li>
    <li><code>php bin/console cache:clear --env=prod</code></li>
    <li><code>php bin/console cache:warmup --env=prod</code></li>
    <li><code>php bin/console assets:install --env=prod</code></li>
    <li><code>php bin/console doctrine:migrations:migrate --no-interaction --env=prod</code></li>
</ol>

<h3>5.4 Workflow Git</h3>
<pre><code># 1. Développer sur feature branch
git checkout release
git checkout -b feature/ma-feature
# ... développement ...
git commit -m "feat: ma feature"
git push origin feature/ma-feature

# 2. Merger dans release (BETA)
git checkout release
git merge feature/ma-feature
git push origin release
# => Appeler deploy.php sur BETA

# 3. Tester sur beta.plongee-venetes.fr

# 4. Si OK, merger dans main (PROD)
git checkout main
git merge release
git push origin main
# => Appeler deploy.php sur PROD</code></pre>

<h2 id="cron">6. Tâches planifiées (Cron HTTP)</h2>

<p>Sur mutualisé, pas de vrai cron. Utiliser <a href="https://cron-job.org" target="_blank">cron-job.org</a> (gratuit).</p>

<h3>6.1 Endpoints disponibles</h3>
<table>
    <tr><th>Tâche</th><th>URL</th><th>Fréquence</th></tr>
    <tr><td>Status</td><td><code>/cron/{token}/status</code></td><td>Test</td></tr>
    <tr><td>CACI Reminder</td><td><code>/cron/{token}/caci-reminder</code></td><td>Lundi 9h</td></tr>
    <tr><td>CACI Retention</td><td><code>/cron/{token}/caci-retention</code></td><td>Tous les jours 3h</td></tr>
</table>

<h3>6.2 Configuration cron-job.org</h3>
<ol>
    <li>Créer un compte sur <a href="https://cron-job.org" target="_blank">cron-job.org</a></li>
    <li>Ajouter les tâches :</li>
</ol>

<table>
    <tr><th>Tâche</th><th>URL</th><th>Schedule</th></tr>
    <tr>
        <td>CACI Reminder</td>
        <td><code>https://plongee-venetes.fr/cron/TOKEN/caci-reminder</code></td>
        <td><code>0 9 * * 1</code></td>
    </tr>
    <tr>
        <td>CACI Retention</td>
        <td><code>https://plongee-venetes.fr/cron/TOKEN/caci-retention</code></td>
        <td><code>0 3 * * *</code></td>
    </tr>
</table>

<h2 id="ftp">7. Accès FTP/SSH</h2>

<h3>7.1 FTP</h3>
<table>
    <tr><th>Paramètre</th><th>Valeur</th></tr>
    <tr><td>Serveur</td><td><code>ftp.cluster007.hosting.ovh.net</code></td></tr>
    <tr><td>Port</td><td><code>21</code></td></tr>
    <tr><td>Utilisateur</td><td><code>hmXXXXX-ovh</code></td></tr>
</table>

<h3>7.2 SSH (optionnel)</h3>
<p>Activer dans Manager OVH → FTP-SSH → Modifier → Accès SSH</p>
<pre><code>ssh hmXXXXX-ovh@ssh.cluster007.hosting.ovh.net</code></pre>

<h2 id="structure">8. Structure des fichiers</h2>

<div class="schema">
/home/hmXXXXX-ovh/
├── www/                          # PROD
│   ├── .env.local               # ⚠️ À créer via FTP
│   ├── .ovhconfig
│   ├── public/
│   │   ├── index.php
│   │   └── deploy.php
│   ├── src/
│   ├── var/
│   │   ├── cache/
│   │   ├── log/
│   │   └── caci_storage/
│   └── vendor/
│
└── beta/                         # BETA
    ├── .env.local               # ⚠️ À créer via FTP
    └── ...
</div>

<h2 id="debug">9. Dépannage</h2>

<h3>Le déploiement Git ne fonctionne pas</h3>
<ul>
    <li>Vérifier que le répertoire est <strong>vide</strong> avant le 1er déploiement</li>
    <li>Vérifier le webhook dans GitHub → Settings → Webhooks → Recent Deliveries</li>
</ul>

<h3>Erreur 500 après déploiement</h3>
<ol>
    <li>Vérifier que <code>.env.local</code> existe</li>
    <li>Appeler <code>deploy.php</code></li>
    <li>Vérifier logs : <code>/var/log/prod.log</code></li>
</ol>

<h3>"Class not found"</h3>
<p>Appeler <code>deploy.php?token=XXX</code> pour relancer composer install.</p>

<h3>Base de données inaccessible</h3>
<ol>
    <li>Vérifier IP OVH autorisée sur O2Switch</li>
    <li>Vérifier DATABASE_URL dans <code>.env.local</code></li>
</ol>

<h2 id="checklist">10. Checklist déploiement initial</h2>

<h3>BETA</h3>
<div class="checklist">
    <label><input type="checkbox"> Webhook GitHub configuré (branche <code>release</code>)</label>
    <label><input type="checkbox"> <code>.env.local</code> créé via FTP dans <code>/beta/</code></label>
    <label><input type="checkbox"> IP OVH autorisée dans O2Switch</label>
    <label><input type="checkbox"> Premier <code>git push origin release</code></label>
    <label><input type="checkbox"> Appel <code>deploy.php?token=XXX</code></label>
    <label><input type="checkbox"> Test https://beta.plongee-venetes.fr</label>
    <label><input type="checkbox"> Connexion admin fonctionne</label>
</div>

<h3>PROD</h3>
<div class="checklist">
    <label><input type="checkbox"> Webhook GitHub configuré (branche <code>main</code>)</label>
    <label><input type="checkbox"> <code>.env.local</code> créé via FTP dans <code>/www/</code></label>
    <label><input type="checkbox"> Premier <code>git push origin main</code></label>
    <label><input type="checkbox"> Appel <code>deploy.php?token=XXX</code></label>
    <label><input type="checkbox"> Test https://plongee-venetes.fr</label>
    <label><input type="checkbox"> Connexion admin fonctionne</label>
    <label><input type="checkbox"> Token deploy.php changé</label>
    <label><input type="checkbox"> CRON_SECRET_TOKEN changé</label>
    <label><input type="checkbox"> Cron jobs configurés sur cron-job.org</label>
</div>

<hr>

<h2>Résumé des commandes</h2>
<table>
    <tr><th>Action</th><th>Commande / URL</th></tr>
    <tr><td>Déployer BETA</td><td><code>git push origin release</code> puis <code>deploy.php?token=XXX</code></td></tr>
    <tr><td>Déployer PROD</td><td><code>git push origin main</code> puis <code>deploy.php?token=XXX</code></td></tr>
    <tr><td>Cron CACI Reminder</td><td>cron-job.org → <code>/cron/TOKEN/caci-reminder</code></td></tr>
    <tr><td>Cron CACI Retention</td><td>cron-job.org → <code>/cron/TOKEN/caci-retention</code></td></tr>
    <tr><td>Logs</td><td>FTP → <code>/var/log/prod.log</code></td></tr>
    <tr><td>Config</td><td>FTP → <code>.env.local</code></td></tr>
</table>

<p style="text-align: center; margin-top: 40px; color: #666;">
    <small>Généré le <script>document.write(new Date().toLocaleDateString('fr-FR'))</script> - Club Subaquatique des Vénètes</small>
</p>

</body>
</html>
