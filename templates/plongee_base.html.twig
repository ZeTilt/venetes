<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Club Subaquatique des V√©n√®tes{% endblock %}</title>
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="{{ asset('assets/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset('assets/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset('assets/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" href="{{ asset('assets/favicon.png') }}">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{% block meta_description %}Club de plong√©e sous-marine √† Vannes - Formations FFESSM, sorties mer, voyages plong√©e{% endblock %}">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CSV Plong√©e">
    <meta name="msapplication-TileColor" content="#1e3a8a">

    <!-- PWA Icons -->
    <link rel="manifest" href="{{ asset('manifest.json') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ asset('pwa-icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ asset('pwa-icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset('pwa-icons/icon-152x152.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset('pwa-icons/icon-152x152.png') }}">
    
    {% block stylesheets %}
        {# Tailwind pour backoffice et pages publiques qui l'utilisent #}
        {% if app.request.pathInfo starts with '/admin' or app.request.pathInfo starts with '/dp' or app.request.pathInfo starts with '/calendrier' %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            'club-orange': '#FD7E29',
                            'club-orange-dark': '#E56B1F',
                            'club-blue': '#1E40AF',
                            'club-blue-dark': '#1E3A8A'
                        }
                    }
                }
            }
        </script>
        {% endif %}
        <link rel="stylesheet" href="{{ asset('assets/nav' ~ (app.environment == 'prod' ? '.min' : '') ~ '.css') }}">
        <link rel="stylesheet" href="{{ asset('assets/layout' ~ (app.environment == 'prod' ? '.min' : '') ~ '.css') }}">
        <link rel="stylesheet" href="{{ asset('assets/gallery' ~ (app.environment == 'prod' ? '.min' : '') ~ '.css') }}">
        <style>
            /* Dropdown navigation avec JavaScript */
            .dropdown-menu {
                transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
                opacity: 0;
                transform: translateY(-10px);
                pointer-events: none;
            }
            .dropdown-menu.show {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }
            .highlight {
                background-color: #FEF3C7;
                color: #92400E;
                padding: 0.125rem 0.25rem;
                border-radius: 0.25rem;
                font-weight: bold;
            }
        </style>
    {% endblock %}

    {% block javascripts %}
        <script src="{{ asset('assets/app' ~ (app.environment == 'prod' ? '.min' : '') ~ '.js') }}" defer></script>
        <script src="{{ asset('assets/carousel' ~ (app.environment == 'prod' ? '.min' : '') ~ '.js') }}" defer></script>
    {% endblock %}
</head>
<body class="body-bg">
    <!-- Header with Logo and Navigation -->
    <header class="nav-header">
        <!-- Top bar -->
        <div class="nav-top-bar">
            <div class="nav-container">
                <div class="nav-content">
                    <div class="nav-contact">
                        <span class="nav-contact-item">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                            </svg>
                            {{ club_info().email }}
                        </span>
                        <span class="nav-contact-item">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                            </svg>
                            {{ club_info().phone }}
                        </span>
                    </div>
                    <div class="nav-social">
                        <a href="{{ club_info().facebook }}" target="_blank">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="nav-main">
            <div class="nav-container">
                <div class="nav-wrapper">
                    <!-- Logo -->
                    <div class="nav-logo">
                        <a href="{{ path('app_home') }}">
                            <img src="{{ asset('assets/logo sans fond.webp') }}" alt="Club Subaquatique des V√©n√®tes">
                            <div class="nav-logo-text">
                                <span class="nav-logo-title">Club Subaquatique</span>
                                <span class="nav-logo-subtitle">des V√©n√®tes</span>
                            </div>
                        </a>
                    </div>

                    <!-- Desktop Navigation (dynamique) -->
                    <div class="nav-desktop">
                        {% include 'partials/_menu.html.twig' with {location: 'main', mode: 'desktop'} %}

                        {# Liens d'authentification - toujours pr√©sents, g√©r√©s par le template #}
                        {% if app.user %}
                            <a href="{{ path('user_profile_index') }}" class="nav-link">
                                Mon profil
                            </a>

                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('admin_dashboard') }}" class="nav-btn nav-btn-blue">
                                    Administration
                                </a>
                            {% else %}
                                <a href="{{ path('app_logout') }}" class="nav-btn nav-btn-gray">
                                    D√©connexion
                                </a>
                            {% endif %}
                        {% else %}
                            <a href="{{ path('app_register') }}" class="nav-link">
                                Cr√©er un compte
                            </a>

                            <a href="{{ path('app_login') }}" class="nav-link">
                                Se connecter
                            </a>
                        {% endif %}

                        <a href="{{ path('app_contact') }}" class="nav-btn nav-btn-orange">
                            Contact
                        </a>
                    </div>

                    <!-- Mobile menu button -->
                    <div class="nav-mobile-toggle-wrapper">
                        <button id="mobile-menu-button" class="nav-mobile-toggle">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile menu (hidden par d√©faut, dynamique) -->
            <div id="mobile-menu" class="nav-mobile">
                <div class="nav-mobile-inner">
                    <a href="{{ path('app_home') }}" class="nav-mobile-link">
                        Accueil
                    </a>

                    {% include 'partials/_menu.html.twig' with {location: 'main', mode: 'mobile'} %}

                    {# Liens d'authentification - toujours pr√©sents, g√©r√©s par le template #}
                    {% if app.user %}
                        <a href="{{ path('user_profile_index') }}" class="nav-mobile-link">
                            Mon profil
                        </a>

                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('admin_dashboard') }}" class="nav-mobile-btn nav-mobile-btn-blue">
                                Administration
                            </a>
                        {% else %}
                            <a href="{{ path('app_logout') }}" class="nav-mobile-btn nav-mobile-btn-gray">
                                D√©connexion
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{{ path('app_register') }}" class="nav-mobile-link">
                            Cr√©er un compte
                        </a>

                        <a href="{{ path('app_login') }}" class="nav-mobile-link">
                            Se connecter
                        </a>
                    {% endif %}

                    <a href="{{ path('app_contact') }}" class="nav-mobile-btn nav-mobile-btn-orange">
                        Contact
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Flash Messages -->
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="flash-container">
                <div class="flash-message flash-message-{{ label == 'success' ? 'success' : (label == 'error' ? 'error' : (label == 'warning' ? 'warning' : 'info')) }}">
                    <div class="flash-icon">
                        {% if label == 'success' %}
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        {% elseif label == 'error' %}
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        {% elseif label == 'warning' %}
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        {% else %}
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        {% endif %}
                    </div>
                    <p class="flash-text">{{ message }}</p>
                </div>
            </div>
        {% endfor %}
    {% endfor %}

    <main>
        {% block body %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div>
                    <h3 class="footer-title">Club Subaquatique des V√©n√®tes</h3>
                    <p class="footer-text">
                        Votre club de plong√©e √† Vannes depuis 1975.
                        Formations FFESSM, sorties mer et voyages plong√©e.
                    </p>
                    <div class="footer-social">
                        <a href="{{ club_info().facebook }}" target="_blank">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                    </div>
                </div>

                <div>
                    <h3 class="footer-title">Liens rapides</h3>
                    <ul class="footer-links">
                        <li><a href="{{ path('public_page_show', {slug: 'qui-sommes-nous'}) }}">Qui sommes nous</a></li>
                        <li><a href="{{ path('public_page_show', {slug: 'nos-activites'}) }}">Nos activit√©s</a></li>
                        <li><a href="{{ path('public_calendar') }}">Calendrier</a></li>
                        <li><a href="{{ path('public_page_show', {slug: 'tarifs-2025'}) }}">Tarifs 2025</a></li>
                        <li><a href="{{ path('blog_index') }}">Actualit√©s</a></li>
                    </ul>
                </div>

                <div>
                    <h3 class="footer-title">Horaires</h3>
                    <div class="footer-schedule">
                        <div class="footer-schedule-row">
                            <span>Mardi</span>
                            <span>20h-22h</span>
                        </div>
                        <div class="footer-schedule-row">
                            <span>Jeudi</span>
                            <span>20h-22h</span>
                        </div>
                        <div class="footer-schedule-row">
                            <span>Samedi</span>
                            <span>14h-16h</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="footer-title">Contact</h3>
                    <div class="footer-contact">
                        <div class="footer-contact-item">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            <span>{{ club_info().address|nl2br }}</span>
                        </div>
                        <div class="footer-contact-item">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                            <span>{{ club_info().email }}</span>
                        </div>
                        <div class="footer-contact-item">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            </svg>
                            <span>{{ club_info().phone }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Club Subaquatique des V√©n√®tes. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('nav-mobile-open');
                });

                // Fermer le menu automatiquement quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenu.classList.remove('nav-mobile-open');
                    });
                });
            }

            // Mobile dropdown toggles
            const mobileDropdownToggles = document.querySelectorAll('.mobile-dropdown-toggle');
            mobileDropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const menu = this.nextElementSibling;
                    if (menu) {
                        menu.classList.toggle('nav-mobile-open');
                        // Rotation de la fl√®che
                        const svg = this.querySelector('svg');
                        if (svg) {
                            svg.style.transform = menu.classList.contains('nav-mobile-open') ? 'rotate(180deg)' : 'rotate(0deg)';
                            svg.style.transition = 'transform 0.2s';
                        }
                    }
                });
            });
        });

        // Gestion des dropdowns desktop
        document.addEventListener('DOMContentLoaded', function() {
            const dropdowns = document.querySelectorAll('.dropdown');
            
            dropdowns.forEach(dropdown => {
                const dropdownMenu = dropdown.querySelector('.dropdown-menu');
                let isHovering = false;
                let timeoutId = null;

                function showDropdown() {
                    clearTimeout(timeoutId);
                    dropdownMenu.classList.add('show');
                }

                function hideDropdown() {
                    timeoutId = setTimeout(() => {
                        if (!isHovering) {
                            dropdownMenu.classList.remove('show');
                        }
                    }, 150); // D√©lai de 150ms pour permettre le passage de la souris
                }

                // √âv√©nements sur le bouton
                dropdown.addEventListener('mouseenter', () => {
                    isHovering = true;
                    showDropdown();
                });

                dropdown.addEventListener('mouseleave', () => {
                    isHovering = false;
                    hideDropdown();
                });

                // √âv√©nements sur le menu d√©roulant
                dropdownMenu.addEventListener('mouseenter', () => {
                    isHovering = true;
                    clearTimeout(timeoutId);
                });

                dropdownMenu.addEventListener('mouseleave', () => {
                    isHovering = false;
                    hideDropdown();
                });

                // Fermer le dropdown en cliquant ailleurs
                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdownMenu.classList.remove('show');
                        isHovering = false;
                    }
                });
            });
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Emp√™che le navigateur d'afficher automatiquement la popup
            e.preventDefault();
            deferredPrompt = e;

            // Affiche un bouton d'installation personnalis√©
            showInstallButton();
        });

        function showInstallButton() {
            // Cr√©e un bouton d'installation discret
            const installButton = document.createElement('button');
            installButton.innerHTML = 'üì± Installer l\'app';
            installButton.className = 'fixed bottom-4 right-4 bg-club-orange text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm font-medium hover:bg-club-orange-dark transition-colors';
            installButton.id = 'install-button';

            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                    installButton.remove();
                }
            });

            // Ajoute le bouton au DOM s'il n'existe pas d√©j√†
            if (!document.getElementById('install-button')) {
                document.body.appendChild(installButton);

                // Cache le bouton apr√®s 10 secondes
                setTimeout(() => {
                    if (installButton.parentNode) {
                        installButton.style.opacity = '0.7';
                    }
                }, 10000);
            }
        }

        // G√®re l'installation r√©ussie
        window.addEventListener('appinstalled', (evt) => {
            console.log('App installed successfully');
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.remove();
            }
        });
    </script>

    <!-- Push Notifications -->
    <script src="{{ asset('js/push-notifications' ~ (app.environment == 'prod' ? '.min' : '') ~ '.js') }}"></script>
    <script>
        // Initialiser le gestionnaire de notifications push
        window.pushManager = null;

        if ('serviceWorker' in navigator && 'PushManager' in window && typeof PushNotifications !== 'undefined') {
            window.pushManager = new PushNotifications('{{ vapid_public_key() }}');

            // Initialiser au chargement
            window.addEventListener('load', async () => {
                await window.pushManager.init();
            });
        }
    </script>
</body>
</html>